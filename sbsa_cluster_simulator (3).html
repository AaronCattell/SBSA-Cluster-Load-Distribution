<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBSA Cluster Load Distribution Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #8B5CF6 0%, #A855F7 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .control-group input {
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .control-group input:focus {
            outline: none;
            border-color: #8B5CF6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B5CF6 0%, #A855F7 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6B7280 0%, #4B5563 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
        }

        .results {
            padding: 30px;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 30px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #bae6fd;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0369a1;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6B7280;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #8B5CF6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-panel {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            margin-top: 20px;
            border-radius: 15px;
            border: 1px solid #f59e0b;
        }

        .info-panel h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .info-panel p {
            color: #a16207;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SBSA Cluster Load Distribution</h1>
            <p>Interactive simulator using Jump Consistent Hashing</p>
        </div>

        <div class="controls">
            <div class="control-grid">
                <div class="control-group">
                    <label for="numNodes">Number of Nodes</label>
                    <input type="number" id="numNodes" value="8" min="2" max="32">
                </div>
                <div class="control-group">
                    <label for="numSlots">Number of SBSA Addresses</label>
                    <input type="number" id="numSlots" value="100000" min="1000" max="1000000" step="1000">
                </div>
                <div class="control-group">
                    <label for="startAddr">Start Address</label>
                    <input type="number" id="startAddr" value="1" min="0">
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="runSimulation()">Run Simulation</button>
                <button class="btn btn-secondary" onclick="resetParams()">Reset Parameters</button>
            </div>
        </div>

        <div class="results">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing SBSA address distribution...</p>
            </div>

            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
            </div>

            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated here -->
            </div>

            <div class="info-panel">
                <h3>About Jump Consistent Hashing</h3>
                <p>
                    This simulation uses Jump Consistent Hashing to distribute SBSA hypercube addresses across cluster nodes. 
                    The algorithm ensures balanced load distribution while maintaining consistency when nodes are added or removed. 
                    Each SBSA address is mapped to exactly one node, creating an efficient distributed storage system.
                </p>
            </div>
        </div>
    </div>

    <script>
        let chart = null;

        // Jump Consistent Hash implementation
        function jumpConsistentHash(key, numBuckets) {
            let b = -1;
            let j = 0;
            
            // Convert to safe integer range to avoid overflow issues
            key = key & 0x7FFFFFFF; // Keep it within 32-bit range
            
            while (j < numBuckets) {
                b = j;
                // Simplified hash function that works reliably in JavaScript
                key = ((key * 1664525) + 1013904223) & 0x7FFFFFFF;
                j = Math.floor((b + 1) * (2147483648 / (key + 1)));
            }
            return b;
        }

        function runSimulation() {
            const numNodes = parseInt(document.getElementById('numNodes').value);
            const numSlots = parseInt(document.getElementById('numSlots').value);
            const startAddr = parseInt(document.getElementById('startAddr').value);

            // Validation
            if (numNodes < 2 || numNodes > 32) {
                alert('Number of nodes must be between 2 and 32');
                return;
            }
            if (numSlots < 1000 || numSlots > 1000000) {
                alert('Number of slots must be between 1,000 and 1,000,000');
                return;
            }

            // Show loading
            document.getElementById('loading').classList.add('active');

            // Use setTimeout to allow UI to update
            setTimeout(() => {
                try {
                    // Generate addresses
                    const addresses = [];
                    for (let i = 0; i < numSlots; i++) {
                        addresses.push(startAddr + i);
                    }

                    // Calculate assignments
                    const assignments = {};
                    for (let i = 0; i < numNodes; i++) {
                        assignments[i] = 0;
                    }

                    for (const addr of addresses) {
                        const node = jumpConsistentHash(addr, numNodes);
                        assignments[node]++;
                    }

                    // Update chart and stats
                    updateChart(assignments, numNodes);
                    updateStats(assignments, numNodes, numSlots);

                } catch (error) {
                    console.error('Simulation error:', error);
                    alert('Error running simulation. Please check your parameters.');
                } finally {
                    // Hide loading
                    document.getElementById('loading').classList.remove('active');
                }
            }, 100);
        }

        function updateChart(assignments, numNodes) {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            const labels = [];
            const data = [];
            const colors = [];
            
            for (let i = 0; i < numNodes; i++) {
                labels.push(`Node ${i}`);
                data.push(assignments[i]);
                colors.push(`hsl(${(i * 360 / numNodes)}, 70%, 60%)`);
            }

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Assigned Addresses',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('60%', '45%')),
                        borderWidth: 2,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'SBSA Cluster Load Distribution (Jump Hash)',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Assigned Addresses'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Node ID'
                            }
                        }
                    }
                }
            });
        }

        function updateStats(assignments, numNodes, numSlots) {
            const counts = Object.values(assignments);
            const min = Math.min(...counts);
            const max = Math.max(...counts);
            const avg = numSlots / numNodes;
            const stdDev = Math.sqrt(counts.reduce((sum, count) => sum + Math.pow(count - avg, 2), 0) / numNodes);
            const loadBalance = ((max - min) / avg * 100).toFixed(2);

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${numNodes}</div>
                    <div class="stat-label">Total Nodes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${numSlots.toLocaleString()}</div>
                    <div class="stat-label">Total Addresses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(avg).toLocaleString()}</div>
                    <div class="stat-label">Avg per Node</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${min.toLocaleString()}</div>
                    <div class="stat-label">Min Load</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${max.toLocaleString()}</div>
                    <div class="stat-label">Max Load</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${loadBalance}%</div>
                    <div class="stat-label">Load Imbalance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stdDev.toFixed(1)}</div>
                    <div class="stat-label">Std Deviation</div>
                </div>
            `;

            document.getElementById('statsGrid').innerHTML = statsHTML;
        }

        function resetParams() {
            document.getElementById('numNodes').value = 8;
            document.getElementById('numSlots').value = 100000;
            document.getElementById('startAddr').value = 1;
        }

        // Run initial simulation on page load
        window.onload = function() {
            runSimulation();
        };
    </script>
</body>
</html>